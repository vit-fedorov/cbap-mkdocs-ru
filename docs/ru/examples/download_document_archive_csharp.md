---
title: Атрибут типа «Документ». Скачивание архива с файлами
tags:
    - C#
    - C#-скрипт
    - скрипт
    - скачать документы
    - документ
    - атрибут типа «Документ»
    - скачать файлы
    - скачать архив
hide: tags
kbId: 2623
---

# Атрибут типа «Документ». Скачивание архива с файлами из таблицы и записи {: #download_document_archive_csharp}

## Введение

**{{ productName }}** позволяет прикрепить любые файлы к атрибуту типа «**Документ**». При этом, если к атрибуту прикреплено несколько файлов, на форме и в таблице каждый файл приходится скачивать отдельно.

С помощью C#-скрипта можно настроить кнопку для скачивания в одном архиве всех файлов, прикреплённых к атрибуту.

Более того, можно скачать все файлы, прикреплённые к атрибуту, из нескольких записей, выбранных в таблице.

Здесь представлен пример настройки кнопки, скачивающей файлы из выбранных записей в таблице. Кроме того, на форме эта кнопка будет скачивать файлы, прикреплённые к атрибуту типа «**Документ**» в текущей записи.

## Прикладная задача

Имеется шаблон _«Реестр документов»_, в котором хранятся файлы. Каждый документ может содержать несколько файлов.

В записи шаблона _«Заявка»_ можно указать документы из _«Реестра документов»_.

Пользователь должен иметь возможность скачать все файлы из всех выбранных строк в таблице на форме в заявке, из выбранных строк в _«Реестре документов»_, а также на форме одного документа.

## Настройка кнопки для скачивания файлов {: .pageBreakBefore }

Чтобы скачать документы, нужно настроить соответствующую кнопку и скрипт для неё.

1. Создайте **шаблон записи** _«Реестр документов»_.
2. Создайте следующие **атрибуты**:

    | Название       | Тип данных   | Свойства                                                                                                    |
    | -------------- | ------------ | ----------------------------------------------------------------------------------------------------------- |
    | _Наименование_ | **Текст**    |                                                                                                             |
    | _Вложения_     | **Документ** | <ul><li>**Хранить несколько значений:** флажок установлен</li><li>**Использовать для поиска записей:** флажок установлен</li></ul> |

    !!! warning "Внимание"

        Для корректного скачивания файлов с помощью C#-скрипта у атрибута типа **«Документ**» рекомендуется установить флажок «**Использовать для поиска записей**». В противном случае скрипт может не сработать.

3. Создайте [**кнопку**][buttons] _«Скачать вложения»_ со следующими свойствами:
    * **Контекст операции:** **запись**;
    * **Операция:** **С# скрипт**;
    * **Результат выполнения:** **скачать документ**.
4. На вкладке «**Скрипт**» добавьте следующий C#-скрипт:

    ``` cs title="Скрипт для скачивания архива с файлами"
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using Comindware.Data.Entity;
    using Comindware.TeamNetwork.Api.Data.UserCommands;
    using Comindware.TeamNetwork.Api.Data;
    using System.IO;
    using System.IO.Compression;

    {% if pdfOutput %}
    ```
    {{ pdfPageBreakHard }}
    ```cs title="Скрипт для скачивания архива с файлами — продолжение"
    {% endif %}
    class Script
    {
        public static UserCommandResult Main(UserCommandContext userCommandContext, Comindware.Entities entities)
        {
    // ObjectIds — массив выбранных записей, полученный из контекста операции кнопки.
            var selected_Ids = userCommandContext.ObjectIds;
    // Создаем массив compressedBytes для хранения архива с файлами.
            byte[] compressedBytes;

            try
            {
    // Vlozheniya — системное имя атрибута «Вложения» шаблона записи «Реестр документов».
    // Помещаем в массив data значения атрибутов «Вложения» из выбранных записей.
    // Создаём поток resultStream для архива
                var data = Api.TeamNetwork.ObjectService.GetPropertyValues(selected_Ids, new[] { "Vlozheniya" });
                using (var resultStream = new MemoryStream())
                {
                    using (var zip = new ZipArchive(resultStream, ZipArchiveMode.Update))
                    {
                        foreach (var id in selected_Ids)
                        {
    // Присваиваем переменной doc_Obj значение атрибута «Вложения».
                            if (data[id].TryGetValue("Vlozheniya", out object doc_Obj) && doc_Obj != null)
                            {
    // Файлы из атрибута «Вложения» помещаем в массив doc_Array.
    // Проверяем, что количество файлов больше 0.
                                var doc_Array = doc_Obj as object[];
                                if(doc_Array.Length > 0)
                                {
    // Каждый файл в массиве doc_Array преобразуем в строку Base64
    // и помещаем в архив fileInArchive.
                                    foreach(var doc in doc_Array)
                                    {
                                        var documentData = Api.TeamNetwork.DocumentService.GetContent(doc.ToString());

                                        var startStream = new MemoryStream();
                                        startStream.Write(documentData.Data, 0, documentData.Data.Length);
                                        startStream.Seek(0, SeekOrigin.Begin);
                                        var fileInArchive = zip.CreateEntry(documentData.Name, CompressionLevel.Optimal);
                                        using (var entryStream = fileInArchive.Open())
                                        {
                                            startStream.CopyTo(entryStream);
                                        }
                                    }
                                }
                            }
                        }
                    }
    // Помещаем поток с результирующим архивом в массив content.
                    compressedBytes = resultStream.ToArray();
                }
                var memStream = new MemoryStream(compressedBytes);
                var content = memStream.ToArray();
    {% if pdfOutput %}
    ```
    ```cs title="Скрипт для скачивания архива с файлами — продолжение"
    {% endif %}
    // Заполняем объект resulterr, который возвращает операция кнопки.
                var resulterr = new UserCommandResult
                {
                    Success = true,
                    Commited = true,
    // Собираем файл архива с именем ZipedFiles.zip и содержимым из массива content.
    // Этот файл скачает браузер после нажатия кнопки.
                    File = new UserCommandFileResult()
                    {
                        Content = content,
                        Name = "ZipedFiles.zip"
                        },
    // Формируем сообщение об успешном выполнении операции кнопки.
                    Messages = new[]
                    {
                        new UserCommandMessage
                        {
                            Severity = SeverityLevel.Normal,
                            Text = "Успешно"
                            }
                    }
                };
                return resulterr;
            }
    // Обрабатываем любые ошибки
            catch
            {
                var resulterr = new UserCommandResult
                {
                    Success = false,
                    Commited = true,
                    ResultType = UserCommandResultType.Notificate,
                    Messages = new[]
                    {
                        new UserCommandMessage
                        {
                            Severity = SeverityLevel.Normal,
                            Text = "Ошибка"
                            }
                    }
                };
                return resulterr;
            }
        }
    }
    ```

5. Поместите атрибуты _«Наименование»_ и _«Вложения»_ в таблицу _«Все записи»_ и на форму шаблона _«Реестр документов»_.
6. Поместите кнопку _«Скачать вложения»_ в **таблицу** _«Все записи»_ шаблона _«Реестр документов»_.
7. В **шаблоне записи** _«Заявка»_ создайте **атрибут**:

    | Название   | Тип данных | Свойства                                                                                       |
    | ---------- | ---------- | ---------------------------------------------------------------------------------------------- |
    | _Документы_ | **Запись** | <ul><li>**Связанный шаблон:** _Реестр документов_</li><li>**Хранить несколько значений:** флажок установлен</li> |

8. Поместите на форму шаблона _«Заявка»_ **атрибут** _«Документы»_ и настройте его **представление** в виде **таблицы**.
9. Поместите в таблицу _«Документы»_ на форме **атрибуты** _«Наименование»_ и _«Вложения»_ шаблона записи _«Реестр документов»_.
10. В область кнопок таблицы _«Документы»_ поместите кнопки «**Создать**» и _«Скачать вложения»_.

## Тестирование

1. Создайте новую запись шаблона _«Заявка»_ и добавьте несколько строк с документами в таблицу _«Документы»_.
2. Выберите строки для скачивания документов и нажмите кнопку _«Скачать вложения»_.
3. Браузер скачает архив с файлами, прикреплёнными к выбранным записям.

    !!! note "Примечание"

        Если в браузере отобразится сообщение «**Незащищенное скачивание заблокировано**», нажмите кнопку «**Сохранить**», чтобы продолжить скачивание.

4. Перейдите к таблице _«Все записи»_ шаблона _«Реестр документов»_.
5. Выберите записи, из которых следует скачать вложения, и нажмите кнопку _«Скачать вложения»_.
6. Браузер скачает архив с файлами из выбранных записей.
7. Откройте любую запись шаблона _«Реестр документов»_ и нажмите кнопку _«Скачать вложения»_.
8. Браузер скачает архив с файлами, прикреплёнными к записи.

    _![Отображение кнопки «Скачать вложения» в таблице записей шаблона «Реестр документов»](download_archive_csharp_button.png)_

<div class="relatedTopics" markdown="block">

--8<-- "related_topics_heading.md"

- _[Атрибут типа «Документ»][attribute_document]_
- _[Кнопки. Определение, настройка, удаление][buttons]_
- _[Написание скриптов на языке C#][manual_csharp]_

</div>

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
