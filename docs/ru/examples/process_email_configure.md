---
title: Отправка, получение и обработка эл. почты в процессе
kbId: 2515
tags:
    - письма
    - передача сообщений между процессам
    - пути передачи данных
    - события
    - сообщения
    - отправка
    - межпроцессное взаимодействие
hide:
    -tags
---

# Отправка, получение и обработка эл. почты в процессе. Пример: настройка подключений, путей передачи данных, диаграммы процесса и сценария {: #process_email_configure}

## Введение

**{{ productName }}** может отправлять и принимать электронные письма, а также передавать сообщения между процессами.

В этой статье представлены инструкции по настройке обмена данными посредством электронных писем и межпроцессного взаимодействия на примере процесса согласования отпуска:

- настройка подключений и путей передачи данных;
- настройка процессов согласования отпуска и обработки эл. писем;
- настройка событий отправки и получения сообщений на диаграммах процессов.

## Прикладная задача

Требуется настроить процесс согласования _Руководителем_ заявлений на отпуск так, чтобы _Руководитель_ мог согласовать отпуск или отказать в отпуске с помощью кнопки в эл. письме с заявлением, не покидая почтового ящика и не выполняя вход в **{{ productName }}**.

Настроим процесс _«Согласование отпуска»_ из следующих шагов:

1. _Заявитель_ подаёт заявление на отпуск.
2. Процесс _«Согласование отпуска»_ отправляет _Руководителю_ эл. письмо от имени _Отдела кадров_ со следующим содержимым:
    - Номер заявления
    - Ф. И. О. заявителя
    - Даты начала и окончания отпуска
    - Количество дней отпуска
    - Кнопки _«Согласовать отпуск»_ и _«Отказать в отпуске»_
    - Инструкции по подаче решения по заявлению
3. _Руководитель_ рассматривает заявление и нажимает в письме кнопку _«Согласовать отпуск»_ или _«Отказать в отпуске»_.
4. При нажатии _Руководителем_ кнопки автоматически создаётся новое письмо со следующим содержимым:
    - получатель — адрес почтового ящика, письма в котором обрабатывает процесс _«Обработка ответа руководителя»;_
    - тема — решение по заявлению и номер заявления.

    !!! note "Примечание"

        _Руководитель_ **не должен изменять адрес получателя и тему** автоматически созданного письма.

        В тексте письма _Руководитель_ может указать в произвольной форме причину решения по заявлению.

5. _Руководитель_ отправляет заполненное письмо с решением по заявлению.
6. Процесс _«Обработка ответа руководителя»_ получает письмо от _Руководителя_, извлекает из него данные и передаёт решение _Руководителя_ в процесс _«Согласование отпуска»._
7. В зависимости от решения _Руководителя_ процесс _«Согласование отпуска»_ отправляет _Заявителю_ уведомление _«Отпуск согласован»_ или _«В отпуске отказано»_ от имени _Отдела кадров_.

### Исходные данные

В приложении _«Отпуска»_ создайте перечисленные ниже шаблоны.

#### Шаблон процесса _«Согласование отпуска»_

Шаблон процесса _«Согласование отпуска»_ свяжите с шаблоном записи [_«Заявления на отпуск»_](#attributes_record_template_vacation_application).

См. также [«Настройка элементов диаграммы процесса _«Согласование отпуска»_](#elements_vacation_agreement_setup).

- _[Оформлено заявление на отпуск](#start_event_application_registered)_ — **простое начальное событие**; соединено с событием _«Отправка уведомления для руководителя»_.
- _[Отправка уведомления для руководителя](#intermediate_event_notification_to_manager)_ — **промежуточное событие-отправка сообщения**; соединено с событием _«Обработан ответ руководителя»_.
- _[Обработан ответ руководителя](#intermediate_event_manager_answer)_ — **промежуточное событие-получение сообщения**; соединено с развилкой _«Решение руководителя»_.
- _[Решение руководителя](#gateway_manager_decision)_ — **развилка «или/или»**; соединена с событиями _«Отпуск согласован»_ и _«В отпуске отказано»_.
- _[Отпуск согласован](#end_event_vacation_accept)_ — **конечное событие-отправка сообщения**.
- _[В отпуске отказано](#end_event_vacation_decline)_ — **конечное событие-отправка сообщения**.

_![Диаграмма процесса «Согласование отпуска»](process_email_configure_vacation_agreement_diagram.png)_

#### Шаблон процесса _«Обработка ответа руководителя»_

_Шаблон процесса «Обработка ответа руководителя»_ свяжите с шаблоном записи _[«Решения руководителя»](#attributes_record_template_manager_decision)._

См. также [«Настройка элементов диаграммы процесса _«Обработка ответа руководителя»_][elements_manager_answer_processing_setup].

- _[Поступил ответ руководителя](#start_event_manager_answer_receive)_ — **начальное событие-получение сообщения**; соединено с конечным событием.
- _[Передача решения в процесс «Согласование отпуска»](#end_event_decision_transfer)_ — **конечное событие-отправка сообщения**.

_![Диаграмма процесса «Обработка ответа руководителя»](process_email_configure_manager_answer_processing_diagram.png)_

#### Атрибуты шаблона записи _«Заявления на отпуск»_ {: #attributes_record_template_vacation_application}

<table markdown="block">
<thead markdown="block">
<tr markdown="block">
<th markdown="block">**Название**</th>
<th markdown="block">**Системное имя**</th>
<th markdown="block">**Свойства**</th>
</tr>
</thead>
<tbody markdown="block">
<tr markdown="block">
<td markdown="block">_№ заявления_</td>
<td markdown="block">_ApplicationNumber_</td>
<td markdown="block">**Тип данных: текст**
</td>
</tr>
<tr markdown="block">
<td markdown="block">_Имя заявителя_</td>
<td markdown="block">_ApplicantName_</td>
<td markdown="block">

**Тип данных: текст**

**Вычислять автоматически**: флажок установлен

**Вычисляемое значение: формула**

``` cs
$_creator->fullName
```

- `$` — ссылка на текущую запись в [шаблоне _«Заявления на отпуск»_](#attributes_record_template_vacation_application).
- `_creator` — системный атрибут, содержащий ID аккаунта, который создал запись.
- `fullName` — системный атрибут, содержащий Ф. И. О. аккаунта.

</td>
</tr>
<tr markdown="block">
<td markdown="block">_Адрес заявителя_</td>
<td markdown="block">_ApplicantEmail_</td>
<td markdown="block">

**Тип данных: текст**

**Вычислять автоматически**: флажок установлен

**Вычисляемое значение: формула**

``` cs
$_creator->mbox
```

- `$` — ссылка на текущую запись в [шаблоне _«Заявления на отпуск»_](#attributes_record_template_vacation_application).
- `_creator` — системный атрибут, содержащий ID аккаунта, который создал запись.
- `mbox` — системный атрибут, содержащий адрес эл. почты аккаунта.

</td>
</tr>
<tr markdown="block">
<td markdown="block">_Дата начала_</td>
<td markdown="block">_StartDate_</td>
<td markdown="block">**Тип данных: дата и время**</td>
</tr>
<tr markdown="block">
<td markdown="block">_Количество дней_</td>
<td markdown="block">_Duration_</td>
<td markdown="block">**Тип данных: число**</td>
</tr>
<tr markdown="block">
<td markdown="block">_Дата окончания_</td>
<td markdown="block">_EndDate_</td>
<td markdown="block">

**Тип данных: дата и время**

**Вычислять автоматически**: флажок установлен

**Вычисляемое значение: формула**

``` cs
ADDDAYS($StartDate, $Duration)
```

- `ADDDAYS()` — эта функция принимает дату и число, прибавляет к дате указанное число
дней и возвращает новую дату.
- `$` — ссылка на текущую запись в [шаблоне _«Заявления на отпуск»_](#attributes_record_template_vacation_application).
- `StartDate, Duration` — атрибуты _«Дата
начала»_ и _«Количество дней»._
</td>
</tr>
<tr markdown="block">
<td markdown="block">_Решение руководителя_</td>
<td markdown="block">_ManagerDecision_</td>
<td markdown="block">

**Тип данных: запись**

**Связанный шаблон:** _[Решения руководителя](#attributes_record_template_manager_decision)_
</td>
</tr>
</tbody>
</table>

#### Атрибуты шаблона записи _«Решения руководителя»_ {: #attributes_record_template_manager_decision}

<table markdown="block">
<thead markdown="block">
<tr markdown="block">
<th markdown="block">**Название**</th>
<th markdown="block">**Системное имя**</th>
<th markdown="block">**Свойства**</th>
</tr>
</thead>
<tbody markdown="block">
<tr markdown="block">
<td markdown="block">_Тема письма с ответом_</td>
<td markdown="block">_ResponseEmailSubject_</td>
<td markdown="block">**Тип данных: текст**</td>
</tr>
<tr markdown="block">
<td markdown="block">_Комментарий руководителя_</td>
<td markdown="block">_ManagerComment_</td>
<td markdown="block">**Тип данных: текст**</td>
</tr>
<tr markdown="block">
<td markdown="block">_№ заявления_</td>
<td markdown="block">_ApplicationNumber_</td>
<td markdown="block">

**Тип данных: текст**

**Вычислять автоматически**: флажок установлен

**Вычисляемое значение: формула**

``` cs
SUBSTRING(
    $ResponseEmailSubject,
    INDEXOF($ResponseEmailSubject,"[")+1,
    INDEXOF($ResponseEmailSubject,"]")-
    INDEXOF($ResponseEmailSubject,"[")-1
)
```

- `SUBSTRING()` — эта функция принимает строку, позиции начала и конца подстроки и возвращает фрагмент исходной строки между указанными позициями.
- `INDEXOF()` — эта функция принимает две строки, ищет в первой строке вторую строку и возвращает число — позицию искомой строки в исходной строке. В противном случае функция возвращает `null`.
- `$` — ссылка на текущую запись в шаблоне _«Решения руководителя»_.
- `ResponseEmailSubject` — атрибут _«Тема письма с ответом»_.
- Данная формула возвращает `true`, если тема письма содержит строку «`Отпуск согласован. Заявление № [X]`», где `X` — номер заявления, состоящий из произвольного количества цифр. В противном случае формула возвращает `false`.

</td>
</tr>
</tr>
<tr markdown="block">
<td markdown="block">_Отпуск согласован_</td>
<td markdown="block">_LeaveApproved_</td>
<td markdown="block">

**Тип данных: логический**

**Вычислять автоматически**: флажок установлен

**Вычисляемое значение: формула**:

``` cs
IF(
   MATCHES($ResponseEmailSubject,
   ".*Отпуск согласован\. Заявление № \[[0-9]+\].*"),
   true,
   false
)
```

- `IF()` — эта функция принимает логическое выражение и два аргумента любого типа. Функция возвращает второй аргумент, если выражение возвращает `true`. В противном случае функция возвращает третий аргумент.
- `MATCHES()` — эта функция принимает строку с темой письма в атрибуте `$ResponseEmailSubject` и регулярное выражение `.*Отпуск согласован\. Заявление № \[[0-9]+\].*`, ищет в строке регулярное выражение и возвращает `true`, если выражение найдено. В противном случае функция возвращает `false`.
- `$` — ссылка на текущую запись в шаблоне _«Решения руководителя»_.
- `ResponseEmailSubject` — атрибут _«Тема письма с ответом»_.
- Данная формула возвращает `true`, если тема письма содержит строку «`Отпуск согласован. Заявление № [X]`», где `X` — номер заявления, состоящий из произвольного количества цифр. В противном случае формула возвращает `false`.

</td>
</tr>
</tr>
</tbody>
</table>

!!! question "Синтаксис регулярного выражения"

    - `.*` — ноль или более любых символов. Точка `.` обозначает любой одиночный символ, а звездочка `*` обозначает, что таких символов может быть ноль или больше. Этот фрагмент позволяет игнорировать любые символы, которые могут предшествовать искомой строке.
    - `Отпуск согласован\. Заявление №` — фиксированная часть искомой строки. Регулярное выражение ищет именно этот текст в указанной последовательности **с точным совпадением прописных и строчных букв**.
        - `\.` — экранированная точка. Точка в регулярном выражении означает любой одиночный символ, поэтому для поиска самой точки её необходимо экранировать с помощью косой черты `\`.
    - `\[` — экранированная квадратная скобка. Квадратные скобки в регулярных выражениях используются для обозначения диапазона символов, поэтому для поиска самой скобки необходимо её экранировать с помощью обратной косой черты `\`. Таким образом, `\[` означает «открывающая квадратная скобка».
    - `[0-9]+` — набор из одной или более цифр. Диапазон `[0-9]` обозначает любую цифру от 0 до 9, а плюс `+` обозначает, что таких цифр может быть одна или более.
    - `\]` — экранированная закрывающая квадратная скобка, аналогичная открывающей.
    - `.*` — ноль или более любых символов. Этот фрагмент позволяет игнорировать любые символы, которые могут следовать за искомой строкой.
    - Ознакомиться с принципами составления регулярных выражений и поэкспериментировать с ними можно на следующем сайте: [https://regex101.com/](https://regex101.com/)

    !!! example "Пример"

        - Дано регулярное выражение:

        ``` css
        .*Отпуск согласован\. Заявление № \[[0-9]+\].*
        ```

        - `"Здравствуйте! Отпуск согласован. Заявление № [12345] одобрено."` —
        **удовлетворяет** регулярному выражению.
        - `"Ваш отпуск согласован. Заявление № [12345]."` — **не удовлетворяет** регулярному выражению, так как слово «`отпуск`» должно начинаться с прописной буквы.

## Настройка подключений

### Отправка эл. почты из процесса {: #email_receive_process}

Настроим подключение к SMTP-серверу для отправки эл. писем от имени _Отдела кадров_.

1. Откройте страницу **[«Администрирование» – «Подключения»][администрирование]**.
2. Выберите пункт **«Создать» – «Подключения к электронной почте» – «Отправка эл. почты из процесса».**
3. Настройте подключение к SMTP-серверу:
    - **Название:** _Письма от отдела кадров_;
    - **Адрес почтового сервера, Порт, Защита данных, Имя пользователя, Пароль:** укажите параметры для доступа к SMTP-серверу;
    - **Адрес отправителя:** укажите адрес эл. почты отдела кадров;
    - **Имя отправителя:** _Отдел кадров_.

### Получение эл. почты в процессе

Настроим подключение к IMAP-серверу для приёма писем с решением по заявлениям от _Руководителя_.

!!! note "Примечание"

    При подключении к IMAP-серверу **{{ productName }}** выступает как почтовый клиент.

    При каждой проверке почтового ящика **{{ productName }}**:

    - обрабатывает новые письма;
    - отмечает новые письма как прочтённые.

    Поэтому для обработки писем с решениями _Руководителя_ рекомендуется использовать отдельный адрес эл. почты, например: _leavedecisions@example.com_.

    Если использовать ящик, на который поступают прочие письма, они тоже будут отмечены как прочитанные.

1. Откройте страницу **[«Администрирование» – «Подключения»][администрирование]**.
2. Выберите пункт **«Создать» – «Подключения к электронной почте» – «Получение эл. почты в процессе»**.
3. Настройте подключение к IMAP-серверу:
    - **Название:** _Ответы от руководителя_;
    - **Протокол, Адрес почтового сервера, Порт, Имя пользователя, Пароль, Защита данных:** укажите параметры для доступа к IMAP-серверу;
    - **Интервал опроса:** укажите интервал, с которым **{{ productName }}** будет проверять наличие новых писем.

## Настройка путей передачи данных

### Отправка уведомления Руководителю {: #notification_to_manager}

Настроим путь передачи данных для отправки заявлений на рассмотрение _Руководителю_.

!!! warning "Бизнес-логика"

    Отправителем писем с заявлениями на отпуск будет указан _Отдел кадров_.

    В письме _Руководителю_ мы будем передавать значения следующих атрибутов [заявления на отпуск](#attributes_record_template_vacation_application): _Номер заявления, Имя заявителя, Дата начала, Количество дней, Дата окончания_.

    В качестве _Номера заявления_ мы будем использовать ID экземпляра процесса _«Согласование отпуска»_.

!!! tip "Подстановка значений атрибутов сообщения в эл. письмо"

    Путь передачи данных для отправки эл. почты из процесса позволяет передавать данные из записей в эл. письмо.

    1. На вкладке «**Атрибуты сообщения**» пути передачи данных задайте набор атрибутов, значения которых требуется передать в путь передачи данных и подставить в сообщение.
    2. На вкладке «**Свойства сообщения**» подставьте значения атрибутов сообщения в любое поле, указав их системные имена в фигурных скобках `{}`.
        - Например, подставьте в тему письма номер заявления и имя заявителя:
            - **Тема:** _Заявление на отпуск № `{ApplicationNumber}` от: `{ApplicantName}`_
    3. Задайте значения атрибутов сообщения с помощью вкладки «**Данные сообщения**» в свойствах **события отправки сообщения**, использующего этот путь передачи данных.

1. В приложении _«Отпуска»_ откройте страницу **«Пути передачи данных»**.
2. Выберите пункт **«Создать» – «Подключения к электронной почте» – «Отправка эл. почты из процесса».**
3. Настройте путь передачи данных:
    - **Основные свойства**
        - **Название:** _Уведомление для руководителя_
        - **Подключение:** _Письма от отдела кадров_
        - **Имя сообщения:** _MessageToApprover_
        - **Приложение:** _Отпуска_
    - **Атрибуты сообщения**

        | **Название**      | **Системное имя**   | **Тип данных**   |
        | ----------------- | ------------------- | ---------------- |
        | _Номер заявления_ | _ApplicationNumber_ | **Текст**        |
        | _Имя заявителя_   | _ApplicantName_     | **Текст**        |
        | _Дата начала_     | _StartDate_         | **Дата и время** |
        | _Количество дней_ | _Duration_          | **Число**        |
        | _Дата окончания_  | _EndDate_           | **Дата и время** |

    - **Свойства сообщения**
        - **Адрес отправителя:** адрес эл. почты _Отдела кадров_
        - **Имя отправителя:** _Отдел кадров_
        - **Кому:** аккаунт или адрес эл. почты _Руководителя_
        - **Тема:** `#!css Заявление на отпуск № {ApplicationNumber} от: {ApplicantName}`
        - **Формат сообщения: HTML**
        - **Сообщение**
            - Перейдите в поле «**Сообщение**».
            - В панели инструментов нажмите кнопку «**Источник**» <i class="fa-light fa-file-code">‌</i>.
            - Введите следующий HTML-код:

                ``` html
                <p>Уважаемый коллега!</p>
                <p>Поступило заявление на отпуск № {ApplicationNumber}.</p>
                <p>Заявитель: {ApplicantName}</p>
                <p>Количество дней: {Duration}</p>
                <p>Даты отпуска: {StartDate}&ndash;{EndDate}</p>
                <p>Просьба согласовать отпуск или отказать в отпуске:</p>
                <ol>
                <li>Нажмите соответствующую кнопку ниже.</li>
                <li>Будет создано новое письмо.</li>
                <li>В теме письма будет указано Ваше решение по заявлению и номер заявления.</li>
                <li><u>Не меняйте тему письма и адрес получателя.</u></li>
                <li>При необходимости укажите причину решения в тексте письма.</li>
                <li>Отправьте письмо.</li>
                </ol>
                <table border="0" cellpadding="6" cellspacing="0">
                <tbody markdown="block">
                <tr markdown="block">
                    <td markdown="block">
                <a href="mailto:leavedecisions@example.com?subject=Отпуск согласован. Заявление № [{ApplicationNumber}]">
                Согласовать отпуск</a>
                    </td>
                    <td markdown="block">
                        <a href="mailto:leavedecisions@example.com?subject=В отпуске отказано. Заявление № [{ApplicationNumber}]&body=Причина отказа:">
                        Отказать в отпуске</a>
                    </td>
                </tr>
                </table>
                ```

            - Снова нажмите кнопку «**Источник**» <i class="fa-light fa-file-code">‌</i>.
            - Должно отобразиться показанное на следующей иллюстрации письмо:

            _![Тема и текст письма для Руководителя с заменителями для подстановки значений атрибутов](process_email_configure_email_manager_example.png)_

### Получение ответа Руководителя {: #manager_answer_receive}

Настроим путь передачи данных для приёма писем от _Руководителя_.

!!! warning "Бизнес-логика"

    Из ответного письма руководителя путь передачи данных будет извлекать тему и текст письма.

    Затем [процесс _«Обработка ответов руководителя»_][elements_manager_answer_processing_setup] будет извлекать из письма данные в шаблон _[«Решения руководителя»](#attributes_record_template_manager_decision):_

    - номер заявления из темы письма — в атрибут _«№ заявления»_
    - решение по заявлению из темы письма — в атрибут _«Отпуск согласован»_;
    - текст письма — в атрибут _«Комментарий руководителя»._

!!! tip "Извлечение значений атрибутов из эл. письма"

    Путь передачи данных для получения эл. почты из процесса позволяет передавать данные из эл. письма в записи.

    - На вкладке «**Атрибуты сообщения**» пути передачи данных задайте набор атрибутов, значения которых требуется извлечь из полученного письма. Для этого создайте атрибуты и сопоставьте их с полями эл. письма.
        - Например, поместите текст эл. письма в атрибут _EmailBody_:
            - **Название:** _Текст письма_
            - **Системное имя:** _EmailBody_
            - **Тип данных: текст**
            - **Поместить тело атрибута в этот атрибут:** _Сообщение_
    - Передайте значения атрибутов сообщения в атрибуты записи с помощью вкладки «**Данные сообщения**» в свойствах **события получения сообщения**, использующего этот путь передачи данных.

1. В приложении _«Отпуска»_ откройте страницу **«Пути передачи данных»**.
2. Выберите пункт **«Создать» – «Подключения к электронной почте» – «Получение эл. почты в процессе».**
3. Настройте путь передачи данных:
    - **Основные свойства**
        - **Название:** _Ответ руководителя_
        - **Подключение:** _Ответы от руководителя_
        - **Имя сообщения:** _ReceiveManagerEmail_ (это имя сообщения в данном примере не используется, поэтому можно ввести произвольное уникальное имя)
        - **Приложение:** _Управление командировками_
        - **Процесс:** _Обработка ответа_
        - **Назначение:** _Новый экземпляр процесса_
    - **Атрибуты сообщения**

        | **Название**   | **Системное имя** | **Тип данных** | **Поместить тело атрибута в этот атрибут** |
        | -------------- | ----------------- | -------------- | ------------------------------------------ |
        | _Тема письма_  | _EmailSubject_    | **Текст**      | **Тема**                                   |
        | _Текст письма_ | _EmailBody_       | **Текст**      | **Сообщение**                              |

### Отправка уведомления _«Отпуск согласован»_ {: #notification_vacation_accept}

Настроим путь передачи данных для отправки уведомлений о согласовании заявления от имени _Отдела кадров_.

1. В приложении _«Отпуска»_ откройте страницу **«Пути передачи данных»**.
2. Выберите пункт **«Создать» – «Подключения к электронной почте» – «Отправка эл. почты из процесса»**.
3. Настройте путь передачи данных:
    - **Основные свойства**
        - **Название:** _Уведомление «Отпуск согласован»_
        - **Подключение:** _Письма от отдела кадров_
        - **Имя сообщения:** _MessageFromHrApproved_
        - **Приложение:** _Отпуска_
    - **Атрибуты сообщения**

        | **Название**               | **Системное имя**   | **Тип данных**   |
        | -------------------------- | ------------------- | ---------------- |
        | _№ заявления_              | _ApplicationNumber_ | **Текст**        |
        | _Имя заявителя_            | _ApplicantName_     | **Текст**        |
        | _Адрес заявителя_          | _ApplicantEmail_    | **Текст**        |
        | _Дата начала_              | _StartDate_         | **Дата и время** |
        | _Количество дней_          | _Duration_          | **Число**        |
        | _Дата окончания_           | _EndDate_           | **Дата и время** |
        | _Комментарий руководителя_ | _ManagerComment_    | **Текст**        |

    - **Свойства сообщения**
        - **Адрес отправителя:** адрес эл. почты _Отдела кадров_
        - **Имя отправителя:** _Отдел кадров_
        - **Кому:**
            - **Адрес получателя**: _`{ApplicantEmail}`_
            - **Имя получателя**: _`{ApplicantName}`_
        - **Тема:** _Отпуск согласован. Заявление № `{ApplicationNumber}`_
        - **Формат сообщения: HTML**
        - **Сообщение**
            - Перейдите в поле «**Сообщение**».
            - В панели инструментов нажмите кнопку «**Источник**» <i class="fa-light fa-file-code">‌</i>.
            - В поле введите следующий HTML-код «**Сообщение**»:

                ``` html
                <p>Здравствуйте, {ApplicantName}!</p>
                <p>Ваш отпуск согласован.</p>
                <p>Заявление №: {ApplicationNumber}</p>
                <p>Количество дней: {Duration}</p>
                <p>Даты отпуска: {StartDate}&ndash;{EndDate}</p>
                <p>Комментарий руководителя:</p>
                <p>{ManagerComment}</p>
                ```

            - Снова нажмите кнопку «**Источник**» <i class="fa-light fa-file-code">‌</i>.
            - Должно отобразиться показанное на следующей иллюстрации письмо:

            _![Тема и текст письма заявителю с уведомлением «Отпуск согласован» с заменителями для подстановки значений атрибутов](process_email_configure_email_agree_example.png)_

### Отправка уведомления _«В отпуске отказано»_ {: #notification_vacation_decline}

Настроим путь передачи данных для отправки уведомлений об отклонении заявления от имени _Отдела кадров_.

1. В приложении _«Отпуска»_ откройте страницу **«Пути передачи данных»**.
2. Выберите пункт **«Создать» – «Подключения к электронной почте» – «Отправка эл. почты из процесса».**
3. Настройте путь передачи данных:
    - **Основные свойства**
        - **Название:** _Уведомление «В отпуске отказано»_
        - **Подключение:** _Письма от отдела кадров_
        - **Имя сообщения:** _MessageFromHrRejected_
        - **Приложение:** _Отпуска_
    - **Атрибуты сообщения**

        | **Название**               | **Системное имя**   | **Тип данных**   |
        | -------------------------- | ------------------- | ---------------- |
        | _№ заявления_              | _ApplicationNumber_ | **Текст**        |
        | _Имя заявителя_            | _ApplicantName_     | **Текст**        |
        | _Адрес заявителя_          | _ApplicantEmail_    | **Текст**        |
        | _Дата начала_              | _StartDate_         | **Дата и время** |
        | _Количество дней_          | _Duration_          | **Число**        |
        | _Дата окончания_           | _EndDate_           | **Дата и время** |
        | _Комментарий руководителя_ | _ManagerComment_    | **Текст**        |

    - **Свойства сообщения**
        - **Адрес отправителя:** адрес эл. почты _Отдела кадров_
        - **Имя отправителя:** _Отдел кадров_
        - **Кому:**
            - **Адрес получателя**: _`{ApplicantEmail}`_
            - **Имя получателя**: _`{ApplicantName}`_
        - **Тема:** _В отпуске отказано. Заявление № `{ApplicationNumber}`_
        - **Формат сообщения: HTML**
        - **Сообщение**
            - Перейдите в поле «**Сообщение**».
            - В панели инструментов нажмите кнопку «**Источник**» <i class="fa-light fa-file-code">‌</i>.
            - В поле введите следующий HTML-код «**Сообщение**»:

                ``` html
                <p>Здравствуйте, {ApplicantName}!</p>
                <p>По Вашему заявлению на отпуск получен отказ.</p>
                <p>Заявление №: {ApplicationNumber}</p>
                <p>Количество дней: {Duration}</p>
                <p>Даты отпуска: {StartDate}&ndash;{EndDate}</p>
                <p>Комментарий руководителя:</p>
                <p>{ManagerComment}</p>
                ```

            - Снова нажмите кнопку «**Источник**» <i class="fa-light fa-file-code">‌</i>.
            - Должно отобразиться показанное на следующей иллюстрации письмо:

            _![Тема и текст письма заявителю с уведомлением «В отпуске отказано» с заменителями для подстановки значений атрибутов](process_email_configure_email_restrict_example.png)_

## Настройка элементов диаграммы процесса _«Согласование отпуска»_ {: #elements_vacation_agreement_setup}

!!! warning "Бизнес-логика"

    1. Процесс _«Согласование отпуска»_ запускается вручную путём создания его экземпляра.
    2. При запуске процесса создаётся запись в шаблоне _[«Оформлено заявление на отпуск»](#attributes_record_template_vacation_application)_, связанная с экземпляром процесса.
    3. Пользователь, запустивший процесс, заполняет стартовую форму события _[«Оформлено заявление на отпуск»][start_event_application_registered]_, указав _дату начала и количество дней_ отпуска.
    4. Событие _[«Отправка уведомления для руководителя»](#intermediate_event_notification_to_manager)_ отправляет [письмо с заявлением](#notification_to_manager) _Руководителю_.
    5. Событие _[«Обработан ответ руководителя»](#intermediate_event_manager_answer)_ ожидает решения _Руководителя_ из процесса _[«Обработка ответа руководителя»][elements_manager_answer_processing_setup]_.
    6. _Руководитель_ нажимает в полученном письме кнопку _«Согласовать отпуск»_ или _«Отказать в отпуске»_ и отправляет автоматически сформированное письмо с решением по заявлению.
    7. Процесс _«Обработка ответа руководителя»_ получает письмо, извлекает из него данные и передаёт решение по заявлению в событие _[«Обработан ответ руководителя»](#intermediate_event_manager_answer)_ процесса _«Согласование отпуска»._
    8. В зависимости от решения _Руководителя_ в процессе _«Согласование отпуска»_ срабатывает конечное событие _[«Отпуск согласован»](#end_event_vacation_accept)_ или _[«В отпуске отказано»](#end_event_vacation_decline)._
    9. Сработавшее конечное событие отправляет _Заявителю_ письмо с решением по заявлению.

1. В приложении _«Отпуска»_ откройте шаблон процесса _«Согласование отпуска»_.
2. Откройте вкладку «**Диаграмма**».
3. Составьте диаграмму процесса, показанную на иллюстрации.
4. Настройте элементы процесса, как указано ниже.

_![Диаграмма процесса «Согласование отпуска»](process_email_configure_vacation_agreement_diagram.png)_

### Начальное событие _«Оформлено заявление на отпуск»_ {: #start_event_application_registered}

1. Выберите начальное событие сообщения _«Оформлено заявление на отпуск»._
2. В [меню элемента][call_element_menu] выберите пункт «**Стартовая форма**» <i class="fa-light fa-window-maximize">‌</i>.
3. Настройте стартовую форму:
    - В свойствах созданной по умолчанию _Новой области_ введите **отображаемое название** _«Оформлено заявление на отпуск»_.
    - Перетащите на область _«Оформлено заявление на отпуск»_ атрибуты:
        - _Имя заявителя_
        - _Адрес заявителя_
        - _Дата начала_
        - _Количество дней_
        - _Дата окончания_
    - Сохраните форму.
4. Вернитесь к диаграмме процесса.
5. Выберите начальное событие _«Оформлено заявление на отпуск»._
6. В меню элемента выберите пункт «**Сценарий на выходе**» .
7. Настройте [сценарий][scenarios]:
    - Внутрь имеющегося действия «**Сменить контекст**» добавьте действие «**Изменить значения атрибутов**».
    - Настройте действие «**Изменить значения атрибутов**»:

<table markdown="block">
<thead markdown="block">
<tr markdown="block">
<th markdown="block">**Атрибут**</th>
<th markdown="block">**Операция со значениями**</th>
<th markdown="block">**Значение**</th>
</tr>
</thead>
<tbody markdown="block">
<tr markdown="block">
<td  markdown="block">_Номер заявления_</td>
<td  markdown="block">**Заменить**</td>
<td  markdown="block">
**Формула:**

``` cs
FORMAT("{0}", LIST($$ProcessObject))
```

- `FORMAT()` — эта функция принимает строку заменителями
    вида `{0}`…`{N}` и список значений. Функция подставляет значения из
    списка в соответствующие заменители и возвращает результирующую строку.
- `LIST()` — эта функция принимает перечень значений и возвращает список, состоящий
    из этих значений.
- `$$ProcessObject` — системная переменная, хранящая ID экземпляра процесса.
- Данная формула преобразует ID экземпляра процесса в строку. Это позволяет присвоить текстовому
    атрибуту _«Номер заявления»_ значение ID экземпляра. Это текстовое значение далее
    используется для привязки ответов _Руководителя_ к заявлениям на отпуск.
</td>
</tr>
</tbody>
</table>

!!! question "Системная переменная ProcessObject"

    В переменной `ProcessObject` хранится ID экземпляра процесса в сценариях по событиям «**Запуск процесса**», «**Вход токена**», «**Выход токена**».

    См. «[Использование переменных в сценарии][scenario_variables]».

_![Сценарий на выходе из начального события «Оформлено заявление на отпуск»](process_email_configure_scenario_start_event_vacation_application.png)_

### Промежуточное событие _«Отправка уведомления для руководителя»_ {: #intermediate_event_notification_to_manager}

1. Выберите промежуточное событие отправки сообщения _«Отправка уведомления для руководителя»._
2. В меню элемента выберите пункт «**Свойства**» <i class="fa-light fa-gear">‌</i>.
3. Настройте свойства события:
    - **Основные**
        - **Название:** _Отпуск согласован_
    - **Дополнительные**
        - **Место назначения: внешний сокет**
        - **Использовать путь передачи данных:** [_Уведомление для руководителя_](#notification_to_manager)
    - **Данные сообщения**

        | **Название**      | **Системное имя**   | **Тип данных**   | **Значение**                   |
        | ----------------- | ------------------- | ---------------- | ------------------------------ |
        | _№ заявления_     | _ApplicationNumber_ | **Текст**        | **Атрибут:** _Номер заявления_ |
        | _Имя заявителя_   | _ApplicantName_     | **Текст**        | **Атрибут:** _Имя заявителя_   |
        | _Дата начала_     | _StartDate_         | **Дата и время** | **Атрибут:** _Дата начала_     |
        | _Количество дней_ | _Duration_          | **Число**        | **Атрибут:** _Количество дней_ |
        | _Дата окончания_  | _EndDate_           | **Дата и время** | **Атрибут:** _Дата окончания_  |

### Промежуточное событие _«Обработан ответ руководителя»_ {: #intermediate_event_manager_answer}

--8<-- "process_message_event_name.md"

1. Выберите промежуточное событие отправки сообщения _«Обработан ответ руководителя»._
2. В меню элемента выберите пункт «**Свойства**» <i class="fa-light fa-gear">‌</i>.
3. Настройте свойства события:
    - **Основные**
        - **Название:** _Ответ руководителя_
    - **Дополнительные**
        - **Использовать путь передачи данных:** флажок снят
        - **Имя сообщения:** _ApproverResponse_
            - Это имя должно совпадать с **именем сообщения** в [конечном событии «Передача решения в процесс «Согласование отпуска»](#end_event_decision_transfer).
    - **Данные сообщения**

        | **Название**           | **Системное имя** | **Тип данных** | **Значение**                        |
        | ---------------------- | ----------------- | -------------- | ----------------------------------- |
        | _Решение руководителя_ | _ManagerDecision_ | **Текст**      | **Атрибут:** _Решение руководителя_ |

### Развилка _«Решение руководителя»_ {: #gateway_manager_decision}

!!! warning "Бизнес-логика"

    Развилка _«Решение руководителя»_ определяет, какое уведомление отправить _Заявителю_:

    - если атрибут _«Отпуск согласован»_ в записи шаблона _[«Решения руководителя»](#attributes_record_template_manager_decision),_ связанной с заявлением на отпуск, имеет значение `true`, срабатывает конечное событие _[«Отпуск согласован»](#end_event_vacation_accept);_
    - в противном случае срабатывает конечное событие _[«В отпуске отказано»](#end_event_vacation_decline);_
    - сработавшее конечное событие отправляет _Заявителю_ письмо с решением по заявлению на отпуск.

1. Выберите развилку «или/или» _«Решение руководителя»_.
2. В меню элемента выберите пункт «**Свойства**» <i class="fa-light fa-gear">‌</i>.
3. Настройте свойства события:
    - **Основные**
        - **Название:** _Решение руководителя_
    - **Дополнительные**

<table markdown="block">
<thead markdown="block">
<tr markdown="block">
<th markdown="block">**Поток «иначе»**</th>
<th markdown="block">**Конечная точка**</th>
<th markdown="block">**Условие**</th>
</tr>
</thead>
<tbody markdown="block">
<tr markdown="block">
<td markdown="block"></td>
<td markdown="block">_Отпуск согласован_</td>
<td markdown="block">

**Формула:**

``` cs
$ManagerDecision->LeaveApproved
```

- `$` — ссылка на текущую запись в  [шаблоне _«Заявления на отпуск»_](#attributes_record_template_vacation_application).
- `ManagerDecision` — атрибут _«Решение руководителя»_, ссылающийся на запись в [шаблоне _«Решения руководителя»_](#attributes_record_template_manager_decision).
- `LeaveApproved` — логический атрибут _«Отпуск одобрен»_ в шаблоне _«Решения руководителя»_.

</td>
</tr>
<tr markdown="block">
<td markdown="block">Флажок установлен</td>
<td markdown="block">_В отпуске отказано_</td>
<td markdown="block"></td>
</tr>
</tbody>
</table>

### Конечное событие _«Отпуск согласован»_ {: #end_event_vacation_accept}

1. Выберите конечное событие-отправки сообщения _«Отпуск согласован»._
2. В меню элемента выберите пункт «**Свойства**» <i class="fa-light fa-gear">‌</i>‌.
3. Настройте свойства события:
    - **Основные**
        - **Название:** _Отпуск согласован_
    - **Дополнительные**
        - **Место назначения: внешний сокет**
        - **Использовать путь передачи данных:** _[Уведомление «Отпуск согласован»][notification_vacation_accept]_
    - **Данные сообщения**

        | **Название**           | **Системное имя** | **Тип данных**   | **Значение**                   |
        | ---------------------- | ----------------- | ---------------- | ------------------------------ |
        | _Решение руководителя_ | _ManagerDecision_ | **Текст**        | **Атрибут:** _ID_              |
        | _Имя заявителя_        | _ApplicantName_   | **Текст**        | **Атрибут:** _Имя заявителя_   |
        | _Дата начала_          | _StartDate_       | **Дата и время** | **Атрибут:** _Дата начала_     |
        | _Количество дней_      | _Duration_        | **Число**        | **Атрибут:** _Количество дней_ |
        | _Дата окончания>_      | _EndDate_         | **Дата и время** | **Атрибут:** _Дата окончания_  |
        | _Комментарий руководителя_ | _ManagerComment_ | **Текст** | **Атрибут: _Решение руководителя→Комментарий руководителя_** |

        !!! note "Примечание"

            Из значений этих атрибутов формируется эл. письмо _Заявителю_ посредством пути передачи данных _[«Уведомление «Отпуск согласован»](#notification_vacation_accept)_.

### Конечное событие _«В отпуске отказано»_ {: #end_event_vacation_decline}

1. Выберите конечное событие-отправки сообщения _«В отпуске отказано»_.
2. В меню элемента выберите пункт «**Свойства**» <i class="fa-light fa-gear">‌</i>.
3. Настройте свойства события:
    - **Основные**
        - **Название:** _В отпуске отказано_
    - **Дополнительные**
        - **Место назначения: внешний сокет**
        - **Использовать путь передачи данных:** _[Уведомление «В отпуске отказано»](#notification_vacation_decline)_
    - **Данные сообщения**

        | **Название**      | **Системное имя**   | **Тип данных**   | **Значение**                   |
        | ----------------- | ------------------- | ---------------- | ------------------------------ |
        | _№ заявления_     | _ApplicationNumber_ | **Текст**        | **Атрибут:** _Номер заявления_ |
        | _Имя заявителя_   | _ApplicantName_     | **Текст**        | **Атрибут:** _Имя заявителя_   |
        | _Дата начала_     | _StartDate_         | **Дата и время** | **Атрибут:** _Дата начала_     |
        | _Количество дней_ | _Duration_          | **Число**        | **Атрибут:** _Количество дней_ |
        | _Дата окончания_  | _EndDate_           | **Дата и время** | **Атрибут:** _Дата окончания_  |
        | _Комментарий руководителя_ | _ManagerComment_ | **Текст** | **Атрибут: _Решение руководителя→Комментарий руководителя_** |

        !!! note "Примечание"

            Из значений этих атрибутов формируется эл. письмо _Заявителю_ посредством пути передачи данных _[«Уведомление «В отпуске отказано»][notification_vacation_decline]_.

## Настройка элементов диаграммы процесса _«Обработка ответа руководителя»_ {: #elements_manager_answer_processing_setup}

1. В приложении _«Отпуска»_ откройте шаблон процесса _«Обработка ответа руководителя»_.
2. Откройте вкладку «**Диаграмма**».
3. Составьте диаграмму процесса, показанную на иллюстрации.
4. Настройте элементы процесса, как указано ниже.

_![Диаграмма процесса «Обработка ответа руководителя»](process_email_configure_manager_answer_processing_diagram.png)_

### Начальное событие _«Поступил ответ руководителя»_ {: #start_event_manager_answer_receive}

!!! warning "Бизнес-логика"

    1. Процесс _«Обработка ответов руководителя»_ запускается при поступлении нового письма в почтовый ящик, указанный в подключении «**[Получение эл. почты в процессе][email_receive_process]**».
    2. При запуске процесса создаётся запись в [шаблоне _«Решения руководителя»_](#attributes_record_template_manager_decision), связанная с экземпляром процесса.
    3. Процесс _«Обработка ответа руководителя»_ обрабатывает поступившие письма и передаёт данные в процесс _«Согласование отпуска»_.
    4. В теме письма от _Руководителя_ содержатся номер заявления на отпуск и решение по нему в следующем формате:

        - `Отпуск согласован. Заявление № [X]`

            или

        - `В отпуске отказано. Заявление № [X]`

        Здесь `X` — номер заявления, состоящий из произвольного количества цифр.

    5. В теле письма может содержаться произвольное сообщение от _Руководителя_.
    6. В свойствах начального события-получения сообщения _«Поступил ответ руководителя»_ мы настраиваем передачу данных из полученного письма от _Руководителя_.
        - Указываем путь передачи данных для получения писем.
        - Сопоставляем атрибуты [пути передачи данных _«Ответ руководителя»_](#manager_answer_receive) с атрибутами [шаблона записи _«Решения руководителя»_](#attributes_record_template_manager_decision):
            - значения атрибутов _«Тема письма»_ и _«Текст письма»_ из ответа руководителя присваиваются атрибутам записи в шаблоне _«Решения руководителя»_:
                - _Тема письма_ с _ответом_;
                - _Текст письма_ с _комментарием руководителя_.
    7. По значению атрибута _«Тема письма с ответом»_ автоматически вычисляются значения атрибутов записи в [шаблоне _«Решения руководителя»_](#attributes_record_template_manager_decision):
        - значение атрибута _«№ заявления»_ совпадает с ID экземпляра процесса _«Согласование отпуска»_, связанного с заявлением на отпуск;
        - атрибут _«Отпуск согласован»_ принимает значение `true`, если отпуск согласован, и значение `false`, если в отпуске отказано.
    8. После обработки письма [конечное событие передаёт _Решение руководителя_ в процесс _«Согласование отпуска»_](#end_event_decision_transfer).

1. Выберите начальное событие-отправки сообщения _«Поступил ответ руководителя»._
2. В меню элемента выберите пункт «**Свойства**» <i class="fa-light fa-gear">‌</i>.
3. Настройте свойства события:
    - **Основные**
        - **Название:** _Получение и разбор ответа от руководителя_
    - **Дополнительные**
        - **Использовать путь передачи данных:** _[Ответ руководителя](#manager_answer_receive)_
    - **Данные сообщения**

        | **Название**   | **Системное имя** | **Тип данных** | **Значение**                            |
        | -------------- | ----------------- | -------------- | --------------------------------------- |
        | _Тема письма_  | _EmailSubject_    | **Текст**      | **Атрибут:** _Тема письма с ответом_    |
        | _Текст письма_ | _EmailBody_       | **Текст**      | **Атрибут:** _Комментарий руководителя_ |

### Конечное событие _«Передача решения в процесс «Согласование отпуска»_ {: #end_event_decision_transfer}

!!! warning "Бизнес-логика"

    1. Конечное событие процесса _«Обработка ответов руководителя»_ передаёт решение _Руководителя_ в экземпляр процесса _«Согласование отпуска»_, связанный с заявлением на отпуск.
    2. В свойствах конечного события-отправки сообщения мы настраиваем передачу ID записи из [шаблона _«Решения руководителя»_](#attributes_record_template_manager_decision) в атрибут _«Решение руководителя»_ записи в [шаблоне _«Заявления на отпуск»_](#attributes_record_template_vacation_application).
        - Посредством **имени сообщения** указываем [промежуточное событие _«Обработан ответ руководителя»_](#intermediate_event_manager_answer).
        - Сопоставляем атрибут сообщения _«Решение руководителя»_ системным атрибутом «**ID**» шаблона записи _«Решения руководителя»_.
    3. Значение этого атрибута передаётся в [промежуточное событие _«Обработан ответ руководителя»_](#intermediate_event_manager_answer) процесса _«Согласование отпуска»_.

1. Выберите конечное событие-отправки сообщения _«Передача решения в процесс «Согласование отпуска»_.
2. В меню элемента выберите пункт «**Свойства**» <i class="fa-light fa-gear">‌</i>.
3. Настройте свойства события:
    - **Основные**
        - **Название:** _Передача решения в процесс «Согласование отпуска»_
    - **Дополнительные**
        - **Место назначения: промежуточное событие**
        - **Имя сообщения:** _ApproverResponse_
            - Это имя должно совпадать с **именем сообщения** в [промежуточном событии _«Обработан ответ руководителя»_](#intermediate_event_manager_answer).
        - **Экземпляр процесса: формула** `$ApplicationNumber`
    - **Данные сообщения**

        | **Название**           | **Системное имя** | **Тип данных** | **Значение**             |
        | ---------------------- | ----------------- | -------------- | ------------------------ |
        | _Решение руководителя_ | _ManagerDecision_ | **Текст**      | **Атрибут:** _ID_        |

## Тестирование процесса _«Согласование отпуска»_

1. Откройте шаблон записи _«Согласование отпуска»_.
2. На вкладке «**Свойства**» нажмите кнопку «**Перейти к экземплярам**».
3. В списке экземпляров процесса, нажмите кнопку «**Создать**».
4. Отобразится всплывающее окно со стартовой формой
5. Заполните поля «**Дата начала**» и «**Количество дней**».
6. Поля «**Имя заявителя**», «**Адрес заявителя**» и «**Дата окончания**» должны заполниться автоматически.
7. Нажмите кнопку «**Создать**».
8. Откройте почтовый ящик _Руководителя._
9. _Руководителю_ должно прийти письмо от _Отдела кадров_, показанное на следующей иллюстрации.

    _![Письмо Руководителю с заявлением на отпуск и кнопками для согласования и отказа в отпуске](process_email_configure_manager_email_with_buttons.png)_

10. Нажмите кнопку «_Согласовать отпуск_» в письме.
11. В почтовом клиенте будет создано новое письмо, показанное на следующей иллюстрации.

    _![Письмо в Отдел кадров с положительном решением по заявлению на отпуск](process_email_configure_accept.png)_

12. Не меняйте адресата и тему письма. Введите произвольный текст письма.
13. Нажмите кнопку «**Отправить**».
14. Откройте почтовый ящик _Заявителя._
15. _Заявителю_ должно прийти письмо от _Отдела кадров_, показанное на следующей иллюстрации.

    _![Письмо Заявителю с положительным решением по Заявлению об отпуске](process_email_configure_email_decline.png)_

16. Аналогичным образом протестируйте работу процесса в случае отказа в отпуске.

--8<-- "related_topics_heading.md"

**[Диаграмма процесса][process_diagram]**

**[Конструктор диаграммы процесса][process_diagram_designer]**

**[Простое начальное событие][none_start_event]**

**[Начальное событие-получение сообщения][receive_message_start_event]**

**[Стартовая форма][process_diagram_forms]**

**[Промежуточное событие-получение сообщения][receive_message_intermediate_event]**

**[Конечное событие-отправка сообщения][send_message_end_event]**

**[Сценарии][scenarios]**

**[Использование переменных в сценарии][scenario_variables]**

**[Список функций языка формул Comindware][formula_function_list]**

{%
include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md"
%}
