<h1>Восстановление базы данных из файла резервной копии в формате .CDBBZ</h1><div class="md-container" data-md-component="container">
<div class="md-main__inner md-grid"><nav aria-label="Содержание" class="md-nav md-nav--secondary">
<div class="mce-toc">
<h2 class="toc-heading">Содержание</h2>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item"><a class="md-nav__link mkdocs_imported_link" href="#введение"> <span class="md-ellipsis"> Введение </span> </a></li>
<li class="md-nav__item"><a class="md-nav__link mkdocs_imported_link" href="#восстановление-базы-данных-и-скриптов"> <span class="md-ellipsis"> Восстановление базы данных и скриптов </span> </a></li>
<li class="md-nav__item"><a class="md-nav__link mkdocs_imported_link" href="#восстановление-индексов-elasticsearch-из-файла-резервной-копии-репозитория"> <span class="md-ellipsis"> Восстановление индексов Elasticsearch из файла резервной копии репозитория </span> </a></li>
<li class="md-nav__item"><a class="md-nav__link mkdocs_imported_link" href="#запуск-и-проверка-конфигурации-экземпляра-по"> <span class="md-ellipsis"> Запуск и проверка конфигурации экземпляра ПО </span> </a></li>
<li class="md-nav__item"><a class="md-nav__link mkdocs_imported_link" href="#связанные-статьи"> <span class="md-ellipsis"> Связанные статьи </span> </a></li>
</ul>
</div>
</nav>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<h2 id="введение">Введение</h2>
<p>Здесь представлены инструкции по восстановлению на чистом экземпляре ПО <strong>Comindware Platform</strong> под управлением ОС Linux базы данных из файла резервной копии с расширением <code>.CDBBZ</code>, созданного с помощью встроенной в ПО функции «<strong>Резервное копирование</strong> ». См. <em>«<a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4642">Резервное копирование. Настройка и запуск, просмотр журнала сеансов</a>»</em>.</p>
<p>См. также инструкции по полному резервному копированию и восстановлению базы данных внешними средствами:</p>
<ul>
<li><em><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4650">Создание полной резервной копии (базы данных, вложенных файлов и журналов) без остановки экземпляра ПО</a></em></li>
<li><em><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4648">Восстановление базы данных, вложенных файлов и журналов из полной резервной копии</a></em></li>
</ul>
<h2 id="восстановление-базы-данных-и-скриптов">Восстановление базы данных и скриптов</h2>
<ol class="colored_numbers_list">
<li>
<p>Перейдите в режим суперпользователя:</p>
<div class="highlight"><code><code></code></code>
<pre><code>su -</code></pre>
</div>
<p>или</p>
<div class="highlight"><code><code></code></code>
<pre><code>sudo -i</code></pre>
</div>
</li>
<li>
<p>Разверните чистый экземпляр ПО Comindware Platform <em>без демонстрационной базы данных</em> (с параметром <code>-d=clear</code>). См. «<a class="mkdocs_imported_link" href="https://kb.comindware.ru/category\.php\?id=807"><strong>Развертывание Comindware Platform</strong></a>». Например:</p>
<div class="highlight"><code><code></code></code>
<pre><code>sh install.sh -k -p <span class="o">[</span>-i<span class="o">=</span>&lt;instanceName&gt;<span class="o">]</span> <span class="o">[</span>-e<span class="o">]</span> -d<span class="o">=</span>clear <span class="o">[</span>-u<span class="o">=</span>www-data<span class="o">]</span> <span class="o">[</span>-g<span class="o">=</span>www-data<span class="o">]</span></code></pre>
</div>
<p>Скрипт <code>install.sh</code> поддерживает следующие ключи:</p>
<ul>
<li><code>k</code> — установить ПО Kafka;</li>
<li><code>e</code> — установить ПО Comindware Platform</li>
<li><code>p</code> — установить ПО Comindware BusComindware Platform</li>
<li><code>d=clear</code> <em>— создать экземпляр ПComindware Platformrm без демонстрационной базы данных;</em></li>
<li><code>d=demo</code> — создать экземпляр ПО Comindware Platform c демонстрационной базой данных (не обязательный ключ по умолчанию);</li>
<li><code>u</code> — пользователь (необязательный ключ);</li>
<li><code>g</code> — группа (необязательный ключ);</li>
<li><code>h</code> — вызов краткой справки по использованию скрипта (этот ключ следует указывать без остальных ключей);</li>
<li><code>kh=hostname</code> — использовать указанный хост для подключения к ПО Kafka (необязательный ключ);</li>
<li><code>kp=portnumber</code> — использовать указанный порт для подключения к ПО Kafka (необязательный ключ);</li>
<li><code>i=&lt;instanceName&gt;</code> — создать экземпляр ПО с указанным именем (необязательный ключ). Имя экземпляра пComindware Platform</li>
</ul>
</li>
<li>
<p>Инициализируйте экземпляр ПО. См. <em>«<a class="mkdocs_imported_link" href="https://kb.comindware.ru/category\.php\?id=807">Развертывание</a></em><a class="mkdocs_imported_link" href="https://kb.comindware.ru/category\.php\?id=807"><em>Comindware Platform</em></a><em>»</em>.</p>
</li>
<li>
<p>Остановите сервисы NGINX и comindware<code>&lt;instanceName&gt;</code> (где <code>&lt;instanceName&gt;</code> — имя экземпляра ПО) и удостоверьтесь, что они остановлены:</p>
<div class="highlight"><code><code></code></code>
<pre><code>systemctl stop nginx comindware&lt;instanceName&gt;   </code><br/><code>systemctl status nginx comindware&lt;instanceName&gt;</code></pre>
</div>
</li>
<li>
<p><a class="mkdocs_imported_link" id="unpack_backup"></a>Распакуйте архив резервной копии в каталог <code>/var/lib/comindware/&lt;instanceName&gt;/</code>:</p>
<div class="highlight"><code><code></code></code>
<pre><code>unzip /tmp/BackupFileName.202302161625.cdbbz -d /var/lib/comindware/&lt;instanceName&gt;/</code></pre>
</div>
</li>
<li>
<p>Если в папке резервной копии (<code>/var/lib/comindware/&lt;instanceName&gt;/</code>) имеется каталог <code>Ignite</code>, переименуйте его в <code>Database</code>:</p>
<div class="highlight"><code><code></code></code>
<pre><code>cd /var/lib/comindware/&lt;instanceName&gt;/   </code><br/><code>mv Ignite Database</code></pre>
</div>
</li>
<li>
<p>Перенесите каталог <code>Scripts</code> резервной копии в каталог <code>Database</code>:</p>
<div class="highlight"><code><code></code></code>
<pre><code>mv Scripts /var/lib/comindware/&lt;instanceName&gt;/Database/</code></pre>
</div>
</li>
<li>
<p>Назначьте перенесённым каталогам права <code>rwxrw-rw-</code>:</p>
<div class="highlight"><code><code></code></code>
<pre><code>chmod -R 766 /var/lib/comindware/&lt;instanceName&gt;</code></pre>
</div>
</li>
<li>
<p>Назначьте перенесенным каталогам владельца:</p>
<p><strong>Astra Linux, Ubuntu, Rocky</strong></p>
<div class="highlight"><code><code></code></code>
<pre><code>chown -R www-data:www-data /var/lib/comindware/&lt;instanceName&gt;</code></pre>
</div>
<p><strong>Альт Сервер</strong></p>
<div class="highlight"><code><code></code></code>
<pre><code>chown -R _nginx:_nginx /var/lib/comindware/&lt;instanceName&gt;</code></pre>
</div>
</li>
</ol>
<h2 id="восстановление-индексов-elasticsearch-из-файла-резервной-копии-репозитория">Восстановление индексов Elasticsearch из файла резервной копии репозитория</h2>
<ol class="colored_numbers_list">
<li>
<p>Остановите службу Elasticsearch и удостоверьтесь, что она остановлена:</p>
<div class="highlight"><code><code></code></code>
<pre><code>systemctl stop elasticsearch   </code><br/><code>systemctl status elasticsearch</code></pre>
</div>
</li>
<li>
<p>Создайте папку репозитория Elasticsearch (например, <code>/var/www/backups/elasticsearch/</code>) и перенесите в неё файлы из каталога <code>History</code> ранее <a class="mkdocs_imported_link" href="#unpack_backup">распакованной резервной копии</a>:</p>
<div class="highlight"><code><code></code></code>
<pre><code>mkdir /var/www/backups/elasticsearch/   </code><br/><code>mv /var/lib/comindware/&lt;instanceName&gt;/History/* /var/www/backups/elasticsearch/</code></pre>
</div>
</li>
<li>
<p>Назначьте папке репозитория и её содержимому права <code>rwxr-xr-x</code>:</p>
<div class="highlight"><code><code></code></code>
<pre><code>chmod -R 755 /var/www/backups/ </code></pre>
</div>
</li>
<li>
<p>Назначьте владельца <code>elasticsearch</code> папке репозитория и её содержимому:</p>
<div class="highlight"><code><code></code></code>
<pre><code>chown -R elasticsearch:elasticsearch /var/www/backups/ </code></pre>
</div>
</li>
<li>
<p>В файле конфигурации <code>/etc/elasticsearch/elasticsearch.yml</code> укажите путь к созданному репозиторию:</p>
<div class="highlight"><code><code></code></code>
<pre><code>path.repo: /var/www/backups/elasticsearch</code></pre>
</div>
</li>
<li>
<p>Запустите службу Elasticsearch:</p>
<div class="highlight"><code><code></code></code>
<pre><code>systemctl start elasticsearch.service </code></pre>
</div>
</li>
<li>
<p>Зарегистрируйте репозиторий (например, <code>repostory_backup</code>) с резервной копией снимка Elasticsearch:</p>
<div class="highlight"><code><code></code></code>
<pre><code>curl -X PUT "localhost:9200/_snapshot/repostory_backup?pretty" -H ’Content-Type: application/json’ -d’  </code><br/><code>{  </code><br/><code>"type": "fs",  </code><br/><code>"settings": {  </code><br/><code>            "location": "/var/www/backups/elasticsearch"  </code><br/><code>            }  </code><br/><code>}  </code></pre>
</div>
<p> </p>
<div class="notice notice-info">
<p class="admonition-title">Примечание</p>
<p>Шаги 7 и 8 не требуются при восстановлении снимка из хранилища S3.</p>
<p>Для восстановления снимка из хранилища S3 используйте репозиторий с именем, совпадающим с префиксом индекса Elasticsearch.</p>
<p>Этот репозиторий создаётся автоматически при запуске резервного копирования</p>
<p>Префикс индекса задаётся в <a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4678">свойствах подключения к Elasticsearch</a>, используемого по умолчанию.</p>
</div>
</li>
<li>
<p>Проверьте содержимое зарегистрированного репозитория:</p>
<div class="highlight"><code><code></code></code>
<pre><code>curl -X GET "localhost:9200/_cat/snapshots/repostory_backup?pretty"</code></pre>
</div>
</li>
<li>
<p>Восстановите снимок Elasticsearch:</p>
<div class="highlight"><code><code></code></code>
<pre><code>curl -X POST "localhost:9200/_snapshot/repostory_backup/backupSession123/_restore?pretty" </code></pre>
</div>
<ul>
<li>В качестве репозитория укажите имя репозитория, созданного на шаге 7, или префикс индекса Elasticsearch (см. <a class="mkdocs_imported_link" href="#s3_repository">примечание</a> выше).</li>
<li>В качестве имени снимка укажите идентификатор резервной копии <strong>без точки перед номером</strong> (например, <code>backupSession.123</code> указывайте как <code>backupSession123</code>) со страницы <a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4642#mcetoc_1gjrihkcn1">«Администрирование» – «Инфраструктура» – «Резервное копирование» – «Журнал»</a>.</li>
</ul>
</li>
<li>
<p>Проверьте наличие индексов в восстановленном каталоге:</p>
<div class="highlight"><code><code></code></code>
<pre><code>curl -X GET "localhost:9200/_cat/indices?pretty"</code></pre>
</div>
</li>
</ol>
<h2 id="запуск-и-проверка-конфигурации-экземпляра-по">Запуск и проверка конфигурации экземпляра ПО</h2>
<ol class="colored_numbers_list">
<li>
<p>Запустите необходимые службы и проверьте их статус:</p>
<div class="highlight"><code><code></code></code>
<pre><code>systemctl start nginx comindware&lt;instanceName&gt;   </code><br/><code>systemctl status nginx comindware&lt;instanceName&gt;</code></pre>
</div>
</li>
<li>
<p>Откройте веб-сайт экземпляра ПО.</p>
</li>
<li>Дождитесь инициализации экземпляра ПО. Этот процесс может занять некоторое время. Может потребоваться обновить страницу браузера.</li>
<li>Удостоверьтесь, что все данные из резервной копии восстановлены.</li>
<li>Проверьте и исправьте конфигурацию экземпляра. См. <em>«<a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4651">Проверка и настройка конфигурации экземпляра ПО Comindware Platform после восстановления из резервной копии</a>».</em></li>
</ol>
<h2 id="связанные-статьи">Связанные статьи</h2>
<p><strong><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4650">Создание полной резервной копии (базы данных, вложенных файлов и журналов) без остановки экземпляра ПО</a></strong></p>
<p><strong><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4648">Восстановление базы данных, вложенных файлов и журналов из полной резервной копии</a></strong></p>
<p><strong><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4642">Резервное копирование. Настройка и запуск, просмотр журнала сеансов</a></strong></p>
<p><strong><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4622">Установка и запуск Comindware Platform</a></strong></p>
<p><strong><a class="mkdocs_imported_link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/snapshots-filesystem-repository.html">Регистрация репозитория Elasticsearch (официальное руководство, английский язык)</a></strong></p>
<p><strong><a class="mkdocs_imported_link" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/restore-snapshot-api.html">Восстановление снимка Elasticsearch (официальное руководство, английский язык)</a></strong></p>
<p><strong><a class="mkdocs_imported_link" href="https://kb.comindware.ru/article\.php\?id=4678">Elasticsearch. Настройка подключения</a></strong></p>
</article>
</div>
</div>
<a class="md-top md-icon mkdocs_imported_link" data-md-component="top" href="#"> <em class="fa-light fa-arrow-up">‌<!--icon--></em> К началу </a></div>