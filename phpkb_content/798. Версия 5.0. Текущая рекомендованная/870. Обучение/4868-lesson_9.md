---
title: Урок 9.  Формирование документов
kbId: 4868
---

# Урок 9. Формирование документов

## Введение

В ходе этого урока вы настроите экспорт PDF-отчёта о затратах на основе данных процесса и по шаблону в формате Excel.

Подробные сведения об использовании шаблонов экспорта см. в статье *«[Шаблоны экспорта][export_templates]»*.

**Предусловие:** пройден *[урок 6 «Усовершенствованный процесс»][lesson_6]*.

**Расчётная продолжительность:** 80 мин.

Примечание

В данном уроке представлен продукт **{{ productName }}** версии 5.0, внешний вид страниц и меню в других версиях продукта может отличаться.

## Формирование авансового отчета

Бизнес-логика

После выполнения рейса *Водитель* должен скачать отчет в формате PDF с отчётом о понесённых затратах.

Настройка шаблона экспорта

Для экспорта данных из **{{ productName }}** необходимо:

- Создать **файл шаблона экспорта** в формате Excel или Word, по которому будет формироваться отчёт.
- Настроить **шаблон экспорта**, посредством которого будут выгружаться данные из **шаблона записи**.
- Настроить **кнопку**, которая будет запускать экспорт данных.

### Создание файла шаблона экспорта

1. Создайте файл Excel `АвансовыйОтчет.XLSX`.
2. Заполните лист Excel, как показано на следующей иллюстрации.

_![Шаблон авансового отчета в формате Excel](/platform/v5.0/tutorial/img/lesson_9_export_template_file.png)_

Внимание!

В **файле шаблона экспорта** необходимо указывать те системные имена, которые вы фактически использовали в своём приложении.

Например, если вы присвоили атрибуту *«Номер заявки»* системное имя `Номерзаявки123`, то именно это имя следует использовать в файле шаблона экспорта.

То есть, если системные имена, приведённые в уроках, не совпадают с фактическими системными именами в вашем приложении, используйте фактические системные имена, а не копируйте их из текста уроков.

Синтаксис файла шаблона экспорта

Файл шаблона экспорта (в формате Excel или Word) может содержать произвольное содержимое и заполнители вида `{ }`.

При экспорте заполнители заменяются экспортированными данными, а остальное содержимое файла шаблона остается неизменным.

Таким образом, вы можете создать сложный макет, например, счет-фактуру, и заполнить его экспортированными данными.

Можно экспортировать отдельные значения атрибутов и наборы данных.

- Чтобы экспортировать значение атрибута текущего шаблона, укажите его системное имя в фигурных скобках, например: `{Номерзаявки}`.
- Чтобы экспортировать значение атрибута связанного шаблона, системное имя атрибута типа «**Запись**», точку и системное имя атрибута связанного шаблона, например: {Типзатрат.Название}
- Чтобы экспортировать набор значений из шаблона, связанного с атрибутом типа «**Запись**», используйте операторы `foreach` и `end`:

  - в начале строки в фигурных скобках укажите оператор `foreach`, двоеточие и системное имя атрибута типа «**Запись**», например: `{foreach:Затраты}`;
  - затем перечислите в фигурных скобках системные имена атрибутов связанного шаблона, например: `{Типзатрат.Название} {Сумма}`;
  - в конце строки введите оператор `end`, двоеточие и системное имя атрибута типа «**Запись**» — `{end:Затраты}`.
- Для экспорта данных из шаблона *«Заявки на автомобили»* используем следующие системные имена его атрибутов:

  - `Итоговаясуммазатрат`
  - `Номерзаявки`
  - `Времяподачи`
- Для экспорта данных из связанного шаблона *«Затраты»* используем следующую конструкцию:

  ```
  {foreach:Расходы} {Тип.Название} {Сумма} {end:Расходы}
  ```

  Здесь:

  - `Затраты` — атрибут типа «**Запись**» в шаблоне *«Заявки на автомобили»*, связанны с шаблоном *«Затраты»*.
  - `Сумма` и `Типзатрат` — атрибуты шаблона *«Затраты»*.
  - `Типзатрат` — атрибут типа «**Запись**» в шаблоне *«Затраты»*, связанный с шаблоном *«Типы затрат»*.
  - `Название` — атрибут шаблона *«Типы затрат»*.

## Настройка шаблона экспорта

1. Откройте шаблон записи *«Заявки на автомобили»*.
2. Перейдите на вкладку «**Шаблоны экспорта**».
3. Нажмите кнопку «**Создать**».
4. Отобразится окно «**Новый шаблон экспорта**».
5. Укажите **название** шаблона экспорта *«Авансовый отчет»*.
6. В поле «**Файл шаблона**» выберите пункт «**Значение**» и загрузите созданный ранее файл `АвансовыйОтчет.XLSX`.
7. В поле «**Имя выходного файла**» выберите пункт «**Значение**» и укажите требуемое имя экспортируемого файла с данными (без расширения файла), например: `Авансовый отчет`.
8. Установите флажок «**Экспортировать как PDF**».
9. Нажмите кнопку «**Сохранить**».

Формирование имени выходного файла

Когда пользователь нажмёт кнопку экспорта, будет сформирован файл с заданным **именем выходного файла** c расширением `DOCX` или `XSLX` (как у исходного файла шаблона экспорта), либо PDF (если установлен флажок «**Экспортировать как PDF**»).

**Имя выходного файла** также можно задать с помощью формулы или текстового атрибута.

_![Настройка свойств шаблона экспорта](/platform/v5.0/tutorial/img/lesson_9_export_template_configure.png)_

## Настройка кнопки экспорта отчёта

При создании шаблона экспорта автоматически создается кнопка экспорта.

Эту кнопку необходимо добавить на форму или в таблицу, чтобы выгружать данные.

### Проверка кнопки экспорта

Удостоверимся, что кнопка экспорта соответствует нашим требованиям.

1. Перейдите на вкладку «**Кнопки***» шаблона *«Заявки на автомобили»*.*

   ![Переход к настройке кнопки экспорта документа](/platform/v5.0/tutorial/img/lesson_9_button_list.png)

   Переход к настройке кнопки экспорта документа
2. Откройте кнопку *«Авансовый отчет»*
3. Проверьте корректность свойств кнопки:

   - **отображаемое название** — Авансовый отчет;
   - **контекст операции**— **Запись**;
   - **операция —** **Экспорт записи**;
   - **результат выполнения** — **Скачать документ**;
   - **шаблон экспорта** — Авансовый отчет.![Свойства кнопки экспорта документа, сформированному по шаблону экспорта](/platform/v5.0/tutorial/img/lesson_9_button_properties.png)

   Свойства кнопки экспорта документа, сформированному по шаблону экспорта

### Добавление кнопки экспорта на форму пользовательской задачи

Поместим кнопку для выгрузки отчёта о затратах на форму задачи *«Выполнить рейс»*.

1. Откройте шаблон *«Заявки на автомобили»*.
2. Перейдите на вкладку «**Формы**».
3. Создайте новую форму.
4. Введите **отображаемое название** формы — *«Выгрузка отчета»*.
5. Измените **отображаемое название** автоматически созданной **новой области** на *«Выгрузка отчета»*.
6. Выделите область кнопок *«Выгрузка отчета»* и перетащите на неё кнопку *«Авансовый отчет»*.
7. Сохраните форму.

   ![Добавление кнопки экспорта документа на форму выгрузки отчета](/platform/v5.0/tutorial/img/lesson_9_button_place_on_form.png)

   Добавление кнопки экспорта документа на форму выгрузки отчета
8. Откройте диаграмму процесса *«Заказ автотранспорта»*.
9. Нажмите кнопку *«**Редактировать*\*».
10. Выберите задачу *«Выполнить рейс»* и в меню элемента нажмите кнопку «**Форма**» *‌*.
11. Разверните в панели элементов шаблон *«Заявки на автомобили»*
12. Перетащите форму *«Выгрузка отчета»* под область *«Выполнить рейс»*.
13. Сохраните форму задачи.

    ![Добавление вложенной формы с кнопкой выгрузки отчета на форму задачи «Выполнить рейс»](/platform/v5.0/tutorial/img/lesson_9_perform_ride_task_form_add_export_form.png)

    Добавление вложенной формы с кнопкой выгрузки отчета на форму задачи «Выполнить рейс»
14. Опубликуйте диаграмму процесса *«Заказ автотранспорта»*.

### Настройка разрешения на использование кнопки экспорта

Для того, чтобы *Водитель* мог воспользоваться кнопкой *«Авансовый отчет»*, необходимо предоставить ему соответствующее разрешение с помощью роли *«Водитель»*.

1. Откройте раздел «**Роли**\*» приложения *«Управление автопарком»*.
2. Откройте роль *«Водитель»*.
3. Перейдите на вкладку «**Разрешения**».
4. Раскройте в панели ресурсов шаблон *«Заявки на автомобили»*.
5. Перетащите кнопку *«Авансовый отчет»* на таблицу разрешений.
6. Установите для кнопки *«Авансовый отчет»* разрешение «**Использование кнопки**»\*.
7. Сохраните роль.

   ![Добавление для роли «Водитель» разрешения на использование кнопки «Авансовый отчет»](/platform/v5.0/tutorial/img/lesson_9_driver_role_add_button_permission.png)

   Добавление для роли «Водитель» разрешения на использование кнопки «Авансовый отчет»

## Тестирование экспорта отчёта о затратах

Примечание

Если вы прошли *[Урок 8 *«Аккаунты, группы и роли»*][lesson_8]*, пользовательские задачи назначаются разным аккаунтам.

Для прохождения процесса вы можете выполнять пользовательские задачи одним из трёх способов:

- Войдите в систему несколько раз с разными аккаунтами: *Заказчик, Секретарь, Водитель, Диспетчер гаража*.
- Создайте заявку на автомобиль. Откройте диаграмму запущенного экземпляра процесса *«Заказ автотранспорта»*. Переходите к задачам с помощью кнопки «**Перейти**» *‌* на панели «**Токены**».
- Назначьте свой аккаунт исполнителем всех пользовательских задач.

1. Перейдите к списку экземпляров шаблона *«Заказ автотранспорта»*.
2. Создайте новую заявку.
3. С помощью страницы «**Мои задачи**» пройдите процесс до задачи *«Выполнить рейс»*.
4. Откройте форму задачи *«Выполнить рейс»* и заполните таблицу затрат.
5. Нажмите кнопку «**Сохранить**».
6. Нажмите кнопку *«Авансовый отчет»* и дождитесь экспорта (скачивания) сформированного PDF-документа.

   ![Выгрузка сформированного по шаблону экспорта документа с помощью кнопки на форме](/platform/v5.0/tutorial/img/lesson_9_download_report.png)

   Выгрузка сформированного по шаблону экспорта документа с помощью кнопки на форме
7. Откройте экспортированный документ.
8. Завершите задачу.

   ![PDF-документ авансового отчета, экспортированный по шаблону в формате Excel](/platform/v5.0/tutorial/img/lesson_9_report.png)

   PDF-документ авансового отчета, экспортированный по шаблону в формате Excel

## Результаты

Вы научились формировать и экспортировать документ по шаблону в формате Excel, подставляя в него фактические данные из приложения.

В ходе [следующего урока][lesson_10] вы научитесь прикреплять файлы к записям.

{% include-markdown ".snippets/hyperlinks_mkdocs_to_kb_map.md" %}
